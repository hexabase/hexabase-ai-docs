# ADR-001: マルチテナントKubernetesプラットフォームアーキテクチャ

**日付**: 2025-06-01  
**ステータス**: 実装済み  
**作成者**: プラットフォームアーキテクチャチーム

## 1. 背景

Hexabase AIは、コスト効率と運用の簡素性を維持しながら、複数のテナントに分離された環境を提供するKubernetes-as-a-Serviceプラットフォームを構築する必要がありました。このプラットフォームは、ステートレスアプリケーション、ステートフルサービス、スケジュールジョブ、サーバーレス関数など、様々なワークロードタイプをサポートする必要がありました。

主な課題は以下でした：
- セキュリティとコンプライアンスのためのテナント間の完全分離
- コスト効率的なリソース利用
- 共有と専用インフラストラクチャの両方のサポート
- 簡単なスケーリングと管理
- 既存のHexabaseエコシステムとの統合

## 2. ステータス

**実装済み** - ホストクラスターとしてK3s、テナント分離にvClusterを使用するコアプラットフォームアーキテクチャが展開され、運用中です。

## 3. 検討された他のオプション

### オプションA: ネームスペースベースのマルチテナンシー
- テナント分離にKubernetesネームスペースを使用
- テナント間通信制御にネットワークポリシー
- リソース管理にResourceQuotaとLimitRange

### オプションB: 複数のK8sクラスター
- テナントごとに独立したKubernetesクラスターをデプロイ
- 管理にクラスターフェデレーションを使用
- 直接のインフラストラクチャプロビジョニング

### オプションC: vClusterベースの仮想クラスター
- 単一のホストK3sクラスター
- テナントワークスペースごとにvCluster
- 分離されたデータプレーンと共有コントロールプレーン

## 4. 決定事項

以下のアーキテクチャで**オプションC: vClusterベースの仮想クラスター**を選択しました：
- 軽量ホストクラスターとしてK3s
- テナントごとの完全なKubernetes API分離にvCluster
- 2つのプラン：共有（ノードごとに複数のvCluster）と専用（排他的ノード）
- 専用ノードプロビジョニングにProxmoxとの統合

## 5. なぜこの選択肢を選んだか？

- **完全なAPI分離**: 各テナントが独自のKubernetes APIサーバーを持ち、テナント間のAPIアクセスを防止
- **コスト効率**: 複数のvClusterが共有インフラストラクチャ上で実行可能
- **柔軟性**: テナントを共有プランと専用プラン間で簡単に移行可能
- **運用の簡素性**: 管理する単一のホストクラスター
- **ネイティブKubernetes**: テナントが完全なKubernetes API互換性を取得

## 6. なぜ他のオプションを選ばなかったか？

### なぜネームスペースベースのマルチテナンシーではないか？
- コンプライアンス要件に対する分離が不十分
- 共有APIサーバーがセキュリティリスクを作成
- 複雑なRBAC管理
- テナントごとのカスタマイズ能力が限定的

### なぜ複数のK8sクラスターではないか？
- 高い運用オーバーヘッド
- 高価なインフラストラクチャ要件
- クラスター間の複雑なネットワーキング
- 大規模での管理が困難

## 7. 未決定事項

- クロスリージョンデプロイメントの長期戦略
- vClusterのディザスタリカバリアプローチ
- 非常に大きなテナント（>100ノード）の移行パス
- Proxmox以外の他のクラウドプロバイダーとの統合

## 8. 考慮事項

### セキュリティ考慮事項
- 各vClusterは制限された権限で実行
- ネットワークポリシーがトラフィック分離を強制
- vCluster実装の定期的なセキュリティ監査

### パフォーマンス考慮事項
- vClusterコントロールプレーンのオーバーヘッドを監視
- 共有インフラストラクチャのスケジューリング最適化
- 定期的な容量計画レビュー

### 運用考慮事項
- 自動化されたvClusterライフサイクル管理
- 監視とアラート戦略
- バックアップとリストア手順

### 将来の考慮事項
- 新しい分離技術の登場時の評価
- vClusterプロジェクトへの改善の貢献を検討
- CNCF サンドボックスプロジェクトへの潜在的移行計画