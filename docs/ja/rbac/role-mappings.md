# ロールマッピング

Hexabase.AI の組み込みロールが特定の権限にどのようにマップされるかを理解することは、効果的なアクセス管理の鍵です。このドキュメントでは、組織レベルとワークスペースレベルの両方でのデフォルトロールに関連する権限を詳しく説明します。

## 組織レベルロール

これらのロールは、プラットフォームの管理および運営機能へのアクセスを制御します。

| ロール                     | 説明                                                     | 主要権限                                                                                                                                                                                                        |
| :----------------------- | :------------------------------------------------------------ | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **`organization_admin`** | 最高レベルのアクセス。組織全体を管理します。 | - ユーザーの招待と管理<br>- ワークスペースの作成、更新、削除<br>- シングルサインオン（SSO）の設定<br>- 請求とサブスクリプションの管理<br>- 組織全体の監査ログの表示<br>- 任意のユーザーに任意のロールを割り当て |
| **`organization_user`**  | 組織の標準メンバーのデフォルトロール。   | - 招待されたワークスペースの表示<br>- ユーザー、請求、ワークスペースは管理不可<br>- 特定のワークスペース_内_でロールを割り当て可能                                                                   |

---

## ワークスペースレベルロール

これらのロールは、特定のワークスペース_内_の Kubernetes リソースへのアクセスを制御します。HKS は、最も一般的な使用例をカバーする3つのデフォルトロールを提供します。

### `workspace_admin`

- **説明**: 特定のワークスペースの完全制御。このロールは通常、環境に責任を持つチームリードまたは DevOps エンジニアに割り当てられます。
- **主要 HKS 権限**:
  - ワークスペースへのユーザーアクセス管理（`developer` または `viewer` ロールの割り当て）
  - リソースクォータやネットワークポリシーなどのワークスペース設定の構成
  - ワークスペース内のすべてのリソースと設定の表示
- **マップされた Kubernetes 権限**:
  - ワークスペースの namespace 内の `*`（すべてのリソース）に対する `*`（すべての動詞）。これは Kubernetes の組み込み `admin` ClusterRole と同等ですが、namespace にスコープされています。

### `developer`

- **説明**: アプリケーション開発者の標準権限。機密性の高いセキュリティやユーザー管理設定へのアクセスを許可することなく、アプリケーションの完全なライフサイクル管理を可能にします。
- **主要 HKS 権限**:
  - アプリケーションワークロードの作成、更新、削除
  - ログの表示とポッドへの exec
  - アプリケーション設定の管理（ConfigMaps、Secrets）
- **マップされた Kubernetes 権限（要約）**:
  - 以下に対する `get`、`list`、`watch`、`create`、`update`、`patch`、`delete`:
    - `pods`、`deployments`、`statefulsets`、`daemonsets`
    - `services`、`ingresses`
    - `jobs`、`cronjobs`
    - `configmaps`、`secrets`
    - `persistentvolumeclaims`
  - `pods/log` に対する `get`、`list`、`watch`

### `viewer`

- **説明**: ワークスペースへの読み取り専用アクセス。アプリケーションを観察する必要があるが変更する必要がないステークホルダー、サポートスタッフ、ジュニア開発者に最適です。
- **主要 HKS 権限**:
  - すべてのリソースとその設定の表示
  - ログの表示
- **マップされた Kubernetes 権限**:
  - ワークスペースの namespace 内のすべてのリソースに対する `get`、`list`、`watch`。これは Kubernetes の組み込み `view` ClusterRole と同等です。

## カスタムロールの作成（エンタープライズプラン）

よりきめ細かい制御が必要な組織向けに、エンタープライズプランではカスタムワークスペースロールの作成が可能です。

**例: `db_operator` ロールの作成**

StatefulSets（データベース用）とそれに関連する Secrets と PVC のみを管理できるロールが必要だとします。

```yaml
# custom-role-db-operator.yaml
apiVersion: hks.io/v1
kind: WorkspaceRole
metadata:
  name: db-operator
spec:
  # このロールが付与する権限
  permissions:
    # StatefulSets の完全制御を許可
    - resources: ["statefulsets"]
      verbs: ["*"]
    # secrets と PVC の完全制御を許可
    - resources: ["secrets", "persistentvolumeclaims"]
      verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
    # デバッグのためのポッド表示を許可
    - resources: ["pods", "pods/log"]
      verbs: ["get", "list", "watch"]
```

このマニフェストを適用した後、組み込みロールと同様に、任意のワークスペースでユーザーに `db_operator` ロールを割り当てることができます。HKS は、バックグラウンドで対応する Kubernetes `Role` と `RoleBinding` を自動的に生成します。