# RBAC ベストプラクティス

ロールベースアクセス制御（RBAC）を適切に設定することは、Hexabase.AI 環境を保護する最も重要な側面の1つです。これらのベストプラクティスに従うことで、安全で管理しやすいシステムを維持できます。

## 1. 最小権限の原則（PoLP）を遵守する

これは、アクセス制御の最も基本的な原則です。

- **必要なもののみを付与**: ユーザーとサービスアカウントは、職務を遂行するために絶対に必要な権限のみを持つべきです。
- **ワイルドカード権限を避ける**: 真に必要でない限り、カスタムロールでリソースや動詞に `*` を使用しないでください。明示的にしてください。
- **`viewer` から始める**: 新しいユーザーがプロジェクトに参加したら、まず `viewer` ロールを付与します。変更を開始する必要がある場合にのみ、権限を `developer` に昇格させます。
- **`workspace_admin` は控えめに使用**: `workspace_admin` ロールは高い特権を持ちます。日常的な開発タスクではなく、ワークスペース自体の管理に責任を持つチームリードまたはプラットフォーム管理者のために予約してください。

## 2. ユーザーとサービスアカウント管理を分離する

- **共有アカウントは使用しない**: すべての人間ユーザーは独自の名前付きアカウントを持つべきです。共有アカウント（例：チーム全体で単一の `developer` アカウント）は使用しないでください。これにより、監査ログを通じて説明責任が確保されます。
- **アプリケーション専用のサービスアカウント**: 各アプリケーションまたは CI/CD ジョブは独自の専用 `ServiceAccount` を持つべきです。これにより権限が分離され、1つのサービスアカウントが侵害されても、影響範囲が限定されます。例えば、`ci-builder` サービスアカウントは `production-app` サービスアカウントと同じ権限を持つべきではありません。

## 3. 2層 RBAC システムを活用する

- **プラットフォーム管理には組織ロールを使用**: `organization_admin` で組織レベルでのユーザー、ワークスペース、請求を管理します。
- **アプリケーション開発にはワークスペースロールを使用**: `workspace_admin`、`developer`、`viewer` でワークスペースレベルでの Kubernetes リソースとアプリケーションライフサイクルを管理します。
- **すべての人に `organization_admin` を与えない**: このロールは、HKS 環境全体のスーパーユーザーになることと同等です。その使用は、信頼できるプラットフォーム管理者の非常に少数に制限すべきです。

## 4. RBAC ポリシーとバインディングを定期的に監査する

- **定期的なレビューをスケジュール**: 少なくとも四半期に一度、`organization_admin` または `workspace_admin` がすべてのロールバインディングをレビューすべきです。
- **古いアクセスを探す**: プロジェクトに関わらなくなったユーザーを削除します。
- **過度に許可的なロールを特定**: 必要以上の権限を持つユーザーがいないかチェックします。`workspace_admin` を `developer` にできないでしょうか？
- **監査を自動化**: `hks` CLI を使用して監査の一部をスクリプト化します。

  ```bash
  # ワークスペース内のすべてのユーザーとそのロールをリスト
  hb list-users --workspace my-prod-space

  # 特定のカスタムロールの権限をチェック
  hb get workspacerole custom-role -o yaml
  ```

## 5. きめ細かい制御にはカスタムロールを使用する

- **デフォルトロールを無理に使わない**: 組み込みの `developer` ロールが特定のタスクには許可的すぎる場合、とりあえず付与するのではなく、カスタムロールを作成してください。
- **例**: `Pods` と `Jobs` のみを作成でき、`Deployments` や `Services` は作成できない `ci-runner` ロールを作成します。
- **例**: すべてのリソースを表示し、デバッグのためにポッドに `exec` できるが、`Secrets` は表示できない `support-staff` ロールを作成します。

## 6. 基盤となる Kubernetes RBAC を保護する

- **手動の `kubectl` 変更を避ける**: `kubectl` を使用して手動で `Roles` や `RoleBindings` を作成しないでください。Hexabase.AI に Kubernetes RBAC リソースを管理させてください。手動でバインディングを作成すると、HKS UI と Kubernetes 状態が同期しない「スプリットブレーン」シナリオに陥り、混乱を招く可能性があります。
- **直接の `kubectl` アクセスを制限**: ほとんどのユーザーにとって、すべての対話は HKS プラットフォーム（UI、CLI、API）を通じて行うべきです。直接の `kubectl` アクセスは、プラットフォーム管理者または緊急時の break-glass シナリオに限定してください。これにより、すべてのアクションが HKS 監査ログを通過することが保証されます。