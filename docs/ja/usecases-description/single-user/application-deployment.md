# アプリケーションをデプロイする

## 1. ユースケース名

アプリケーションをデプロイする

## 2. アクター（実行者）

- **主アクター：** 個人開発者(以下、開発者)
- **副アクター：** Hexabase.AIシステム(以下、システム)
- **副アクター：** HKS CLI(CLIからHexabase.AIシステムを利用するためのツール)
- **副アクター：** コンテナレジストリ(Hexabase.AIの内部レジストリ、もしくは外部のレジストリ)

## 3. 事前条件

- インターネット接続が利用可能である
- 開発者はブラウザーまたはHKS CLIが利用可能であり、ログイン済みである
- 開発者はワークスペースとプロジェクトを作成済みである
- 開発者は外部のコンテナレジストリを使用する場合必要なアクセス権限を持っている
- 開発者はデプロイするアプリケーションを開発済みである

## 4. 成功シナリオ（基本フロー）

### 4a. 成功シナリオ（基本フロー）

1. 開発者は開発したアプリケーションをビルドしてコンテナイメージをビルドする
   - ビルドにはHKS CLI、もしくは開発者が用意したツール(例：docker build)を使用する
2. 開発者は必要な場合、4a.6 アプリケーション起動までに、PostgreSQLを準備する(並行作業可)
   - [4b.拡張フロー：データベース(PostgreSQL)が必要な場合](#4b-拡張フローデータベースpostgresqlが必要な場合)を参照
3. 開発者がHKS CLIを使用してデプロイメントコマンドを実行する
4. HKS CLIが開発者のコンテナイメージを任意のコンテナレジストリにプッシュする
   - プッシュ先のコンテナレジストリはHKS CLI のオプションまたは設定で指定する
5. HKS CLI はコンテナのプッシュ完了後に、システムにデプロイの指示を出す
6. システムはプッシュ済みのコンテナイメージをワークスペースに紐付くvClusterにプルする
   - ネームスペースは指定したプロジェクトの情報を使用する
7. システムはコンテナイメージを実行し、アプリケーションを起動する
   - システムは必要な場合、アプリケーションとデータベース間の接続を設定する
8. システムがアプリケーションのURLとアクセス情報をHKS CLIに返し、出力する
9. 開発者がブラウザーなど、アプリケーションの実行環境で動作を確認する

### 4b. 拡張フロー：データベース(PostgreSQL)が必要な場合

開発者はデータベースが不要な場合、このフローをスキップする。

1. データベースが必要な場合、開発者がブラウザーでHKSマーケットプレイスを開く
   - マーケットプレイスはHKS CLIからの利用はできない
2. マーケットプレイスからPostgreSQLインスタンスを選択し、プロジェクトに展開を指示
3. システムが永続ストレージボリュームを作成し、PostgreSQLをプロビジョニングする

## 5. 代替シナリオ（代替フロー）

### 5a. コンテナイメージ作成失敗

- 4a.1a. ビルドに使用したツールがエラーログを出力する
- 4a.1b. 開発者が修正後、再ビルドを実行する

### 5b. コンテナレジストリへのプッシュ失敗

- 4a.4a. ネットワーク障害、ストレージ容量不足などでプッシュに失敗する
- 4a.4b. システムもしくは外部のコンテナレジストリがエラーメッセージを表示する
- 4a.4c. 開発者はエラーメッセージを見て、必要な対応を行う
  - ネットワーク障害：ネットワークの設定を確認する
  - ストレージ容量不足： 開発者が不要なイメージを削除するか、プランをアップグレードする
- 4a.4d. 開発者が再度プッシュを実行する

### 5c. デプロイメント失敗

- 4a.5a. コンテナイメージのプルに失敗する
- 4a.5b. システムは状態をデプロイメント前に戻す
  - データベース、vClusterが対象
- 4a.5c. システムがエラーログを表示する
- 4a.5d. 開発者がイメージの存在とアクセス権限を確認する
- 4a.5e. 開発者が修正後、再デプロイを実行する

### 5d. 共有ノードプールのリソース不足

- 4a.5a. システムがアクセス集中により、共有ノードプールの処理に必要なリソースが不足している
- 4a.5b. システムが待機状態のメッセージを表示する
- 4a.5c. システムがリソースが利用可能になり次第、自動的にデプロイメントを継続する

### 5e. メモリー制限超過

- 4a.7a. 開発者が使用できるメモリーの制限を超過している
- 4a.7b. システムがメモリー制限超過のエラーメッセージを表示する
- 4a.7c. 開発者が動作中の不要なコンテナを停止するか、プランをアップグレードする

### 5f. PostgreSQLプロビジョニング失敗

- 4b.3a. PostgreSQLをプロビジョニングするためのリソースが不足している
- 4b.3b. システムが制限超過のエラーメッセージを表示する
- 4b.3c. 開発者が動作中の不要なコンテナを停止するか、プランをアップグレードする

### 5g. ストレージ制限超過

- 4b.3a. 永続ストレージの制限を超過している
- 4b.3b. システムがストレージ制限超過のエラーメッセージを表示する
- 4b.3c. 開発者が不要なデータを削除するか、プランをアップグレードする

## 6. 事後条件

- アプリケーションが共有ノードプールで実行されている
- PostgreSQLを使用した場合、プロビジョニングされアプリケーションと接続されている
- アプリケーションがパブリックURLでアクセス可能になっている
- システムによってモニタリングされたリソース使用量を開発者はブラウザーやHKS CLIから確認できる

## 7. 補足事項

- コンテナレジストリの詳細については[コンテナレジストリサービス](../../registry/index.md)を参照
  - サポートするコンテナレジストリ、脆弱性スキャン等
- リソース要求/制限の詳細な設定方法については[アプリケーションデプロイメント](../../applications/deployment.md#リソース管理)を参照

## 8. 仕様未定／要検討

- TODO:デプロイ処理はHKS CLIから行うものか？ブラウザーは対象外か？
- 4b.2. TODO: PostgreSQLをプロビジョニングするときの設定値はどうやって決める？初期値？
  - ID、パスワードなど
