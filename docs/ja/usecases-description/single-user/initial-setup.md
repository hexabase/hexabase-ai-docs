# 初回ログイン後のワークスペースセットアップ

## 1. ユースケース名

初回ログイン後のワークスペースセットアップ

## 2. アクター（実行者）

- **主アクター：** 個人開発者(以下、開発者)
- **副アクター：** Hexabase.AIシステム(以下、システム)
- **副アクター：** HKS CLI(CLIからHexabase.AIシステムを利用するためのツール)

## 3. 事前条件

- インターネット接続が利用可能である
- 開発者はブラウザーまたはHKS CLIが利用可能である
- 開発者はHexabase.AIアカウントにログインし、管理者権限を持つ組織が作成済みである
  - 初回ログインと組織の作成は[IdPでHexabase.AIに初回ログインする](../common/external-auth-signup.md)を参照

## 4. 成功シナリオ（基本フロー）

### 4a. 成功シナリオ（基本フロー）:ブラウザー使用時

1. システムは開発者がワークスペースを作成済みかチェック、ワークスペースが存在しない場合はワークスペースの作成を促す画面を表示
   - ワークスペースが存在する場合は 4a.5 "ダッシュボード表示"へ遷移
2. 開発者が名前やプランなど必要な情報を入力し、ワークスペースを作成する
3. システムがワークスペースを作成する
   - ユーザーはこのワークスペースの"管理者"となる
4. システムが開発者用のvClusterをプロビジョニングする
5. システムが開発者用のプロジェクトを作成する
   - プロジェクトは初期値で作成する
   - ユーザーはプロジェクトの"管理者"となる
6. システムが開発者用のvClusterにネームスペースを設定する
7. システムはダッシュボード画面へ遷移する
8. 開発者はワークスペースとプロジェクト、vClusterの情報を確認する
   - ワークスペースやプロジェクトの情報、vClusterで利用可能なリソース、クォータ、ネームスペースの設定など
9. 必要に応じて、ワークスペースやプロジェクトの設定を変更する

### 4b. 成功シナリオ（基本フロー）:HKS CLI使用時

1. 開発者はワークスペースを作成するコマンドを実行する
2. 開発者はHKS CLI上に必要な情報を入力する
3. システムがワークスペースを作成する
   - ユーザーはこのワークスペースの"管理者"となる
4. システムが開発者用のvClusterをプロビジョニングする
5. システムが開発者用のプロジェクトを作成する
   - プロジェクトは初期値で作成する
   - ユーザーはプロジェクトの"管理者"となる
6. システムが開発者用のvClusterにネームスペースを設定する
7. システムが完了メッセージを出力する
8. 開発者は情報を確認するコマンドからワークスペースとプロジェクト、vClusterの情報を確認する
   - ワークスペースやプロジェクトの情報、vClusterで利用可能なリソース、クォータ、ネームスペースの設定など
9. 必要に応じて、ワークスペースやプロジェクトの設定を変更する

## 5a. 代替シナリオ（代替フロー）

### 5a. 代替シナリオ（代替フロー）:ブラウザー使用時

#### 5a.1. 開発者がワークスペース未作成の状態でワークスペースが必要な機能にアクセスする

- 4a.1a. システムはブラウザーワークスペース作成画面に遷移させ、先にワークスペースを作成するように促す
- 4a.1b. 開発者はワークスペースを作成する

#### 5a.2. ワークスペース作成失敗

- 4a.3a. システムの障害により、ワークスペースの作成が失敗する
  - アクセス集中、DBとの接続エラー等
- 4a.3b. システムはワークスペース作成前の状態に戻す
  - DBにワークスペースが登録されていない状態
- 4a.3c. システムは開発者に"しばらく待ってから再試行してください"メッセージを表示する
- 4a.3d. 開発者は一定時間待った後に再試行する、解決しない場合はシステムサポートに連絡する

#### 5a.3. vClusterをプロビジョニング失敗

- 4a.4a. システムがvClusterのプロビジョニングに失敗した
  - リソースの不足、ネットワークエラー、タイムアウト、Kubernetesクラスタ自体の障害等
- 4a.4b. システムはワークスペース作成前の状態に戻す
  - DBにワークスペースとプロジェクトが登録されていない状態、Kubernetesでリソースが確保されていない状態
- 4a.4c. システムは開発者に"しばらく待ってから再試行してください"メッセージを表示する
- 4a.4d. 開発者は一定時間待った後に再試行する、解決しない場合はシステムサポートに連絡する

#### 5a.4. プロジェクト作成失敗

- 4a.5a. システムの障害により、プロジェクトの作成が失敗する
  - アクセス集中、DBとの接続エラー等
- 4a.5b. システムはプロジェクト作成前の状態に戻す
  - DBにプロジェクトが登録されていない状態へロールバックする
- 4a.5c. システムは開発者に"しばらく待ってから再試行してください"メッセージを表示する
- 4a.5d. 開発者は一定時間待った後にプロジェクト作成を再試行する、解決しない場合はシステムサポートに連絡する

#### 5a.5. ネームスペース作成失敗

- 4a.6a. システムがKubernetesのネームスペース作成に失敗した
  - ネットワークエラー、タイムアウト、Kubernetesクラスタの障害
- 4a.6b. システムはプロジェクト作成前の状態に戻す
  - DBにワークスペースとプロジェクトが登録されていない状態、Kubernetesでリソースが確保されていない状態
- 4a.6c. システムは開発者に"しばらく待ってから再試行してください"メッセージを表示する
- 4a.6d. 開発者は一定時間待った後にプロジェクト作成を再試行する、解決しない場合はシステムサポートに連絡する

### 5b. 代替シナリオ（代替フロー）:HKS CLI使用時

#### 5b.1. 開発者がワークスペース未作成でワークスペースが必要なコマンドを実行する

- 4b.2a. システムは開発者のコマンドを中断し、先にワークスペースを作るように促す
- 4b.2b. 開発者はワークスペースを作成するコマンドを実行する

#### 5b.2. ワークスペース作成失敗

- 4b.3a. システムがアクセス集中により、リソースが不足しワークスペース作成が失敗する
  - アクセス集中、DBとの接続エラー等
- 4b.3b. システムはワークスペース作成前の状態に戻す
  - DBにワークスペースとプロジェクトが登録されていない状態
- 4b.3c. システムは"しばらく待ってから再試行してください"メッセージを出力する
- 4b.3d. 開発者は一定時間待った後に再試行する、解決しない場合はシステムサポートに連絡する

#### 5b.3. vClusterをプロビジョニング失敗

- 4b.4a. システムがvClusterをプロビジョニングするためのリソースが不足、もしくは他の理由で失敗した
  - 失敗の理由:ネットワークエラー、タイムアウト、Kubernetesクラスタ自体の障害等
- 4b.4b. システムはワークスペース作成前の状態に戻す
  - DBにワークスペースとプロジェクトが登録されていない状態、Kubernetesでリソースが確保されていない状態
- 4b.4c. システムは"しばらく待ってから再試行してください"メッセージを出力する
- 4b.4d. 開発者は一定時間待った後に再試行する、解決しない場合はシステムサポートに連絡する

#### 5b.4. プロジェクト作成失敗

- 4a.5a. システムの障害により、プロジェクトの作成が失敗する
  - アクセス集中、DBとの接続エラー等
- 4a.5b. システムはプロジェクト作成前の状態に戻す
  - DBにプロジェクトが登録されていない状態へロールバックする
- 4a.5c. システムは開発者に"しばらく待ってから再試行してください"メッセージを表示する
- 4a.5d. 開発者は一定時間待った後にプロジェクト作成を再試行する、解決しない場合はシステムサポートに連絡する

#### 5b.5. ネームスペース作成失敗

- 4a.6a. システムがKubernetesのネームスペース作成に失敗した
  - ネットワークエラー、タイムアウト、Kubernetesクラスタの障害
- 4a.6b. システムはプロジェクト作成前の状態に戻す
  - DBにワークスペースとプロジェクトが登録されていない状態、Kubernetesでリソースが確保されていない状態
- 4a.6c. システムは開発者に"しばらく待ってから再試行してください"メッセージを表示する
- 4a.6d. 開発者は一定時間待った後にプロジェクト作成を再試行する、解決しない場合はシステムサポートに連絡する

## 6. 事後条件

- システム内に開発者専用の隔離されたワークスペースと初期値のプロジェクトが作成されている
- 開発者がワークスペースやプロジェクトの情報にアクセスできる状態になっている
  - ブラウザー:ダッシュボード画面からアクセス可能
  - HKS CLI:ワークスペースの情報取得コマンドが使用可能
- システムでvClusterがプロビジョニングされ、リソースクォータと制限が設定されている
- システムでvClusterにネームスペースが割り当てられている

## 7. 補足事項

- HKS CLIの詳細な使用方法については、各機能のドキュメントを参照

## 8. 仕様未定／要検討

- 5a.1. TODO:ブラウザー使用時、開発者がワークスペース未作成の状態で他の機能にアクセスしようとしたとき
  - 他の機能にアクセスできないようにリンクやボタンを非活性状態にするか？
  - モーダルダイアログを表示し必ずワークスペースを作成するようにするか？
- 4a.3./4b.3. TODO:プロジェクトを自動作成するときの初期値
- 4a.6./4b.6. TODO:ワークスペースの情報で確認可能な内容を決める
