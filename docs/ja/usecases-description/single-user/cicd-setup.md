# CI/CDパイプラインを設定する

## 1. ユースケース名

CI/CDパイプラインを設定する

## 2. アクター（実行者）

- **主アクター：** 個人開発者(以下、開発者)
- **副アクター：** GitHubリポジトリ、GitLabリポジトリ
- **副アクター：** Hexabase.AIシステム(以下、システム)
- **副アクター：** コンテナレジストリ(Hexabase.AIの内部レジストリ、もしくは外部のレジストリ)
- **副アクター：** HKS CLI(CLIからHexabase.AIシステムを利用するためのツール)

## 3. 事前条件

- GitHub、もしくはGitLabリポジトリにアプリケーションコードが存在する
- GitLabを使用する場合、GitLabとシステム間で通信が可能なこと
  - セルフホスティングされたGitLabの場合、システムと通信できない可能性があるため
- 開発者はワークスペースとプロジェクトを作成済みである
- 開発者は外部のコンテナレジストリを使用する場合、必要なアクセス権限を持っている
- 開発者はデプロイするアプリケーションを開発済みである

## 4. 成功シナリオ（基本フロー）

### 4a. 成功シナリオ（基本フロー）:ブラウザーとGitHubを使用時

1. 開発者がブラウザーを用いてCI/CD設定画面にアクセスする
2. 開発者が「GitHubリポジトリを接続」ボタンをクリックする
3. システムがGitHub認証画面にリダイレクトする
4. 開発者がGitHubでアクセス許可を承認する
5. システムが利用可能なリポジトリ一覧を表示する
6. 開発者が対象のリポジトリを選択する
7. システムがCI/CDテンプレート選択画面を表示する
   - Node.jsアプリケーション、マイクロサービス、REST APIなどのテンプレートから選択可能
8. 開発者がテンプレートを選択する、もしくはテンプレートを選択せずに作成する
9. システムがパイプライン設定の詳細画面を表示する
10. 開発者がビルド設定を確認・調整する
    - ビルド戦略（Docker、Buildpack、Kaniko）の選択
    - Dockerfileのパス指定（Dockerビルドの場合）
    - ビルドコンテキストの設定
    - キャッシュ戦略の設定
11. 開発者がデプロイメント設定を確認・調整する
    - デプロイメント戦略（ローリング、ブルーグリーン、カナリー）の選択
    - 環境別設定（開発、ステージング、本番）
    - ヘルスチェックの設定
12. 開発者が環境変数とシークレットを設定する
    - ビルド時環境変数の設定
    - GitHubシークレットとの連携設定
13. 開発者がトリガー設定を確認・調整する
    - プッシュトリガーのブランチパターン（main、develop、feature/*）
    - プルリクエストトリガーの設定
    - スケジュールトリガーの設定（必要に応じて）
14. 開発者が「パイプライン作成」ボタンをクリックする
15. システムがパイプライン設定ファイル`.hexabase/pipeline.yml`を生成する
16. 開発者がパイプライン設定ファイルをダウンロードし、リポジトリにコミットする
17. システムがWebhookをGitHubリポジトリに設定する
18. 開発者がリポジトリにプッシュすると、Webhookによりパイプライン実行が開始される
19. システムがパイプライン実行状況を表示する
20. 開発者がビルドログとデプロイメント状況を確認する

### 4b. 成功シナリオ（基本フロー）:HKS CLIとGitHubを使用時

1. 開発者がHKS CLIを用いて、GitHubに接続するコマンドを実行する
2. HKS CLIがブラウザーを開き、GitHub認証画面を開く
3. 開発者がGitHubでアクセス許可を承認する
4. 開発者がHKS CLIを用いて、利用可能なリポジトリ一覧を表示するコマンドを実行する
5. 開発者が対象のリポジトリを選択するコマンドを実行する
6. 開発者がHKS CLIを用いて、利用可能なCI/CDテンプレート一覧を表示するコマンドを実行する
   - Node.jsアプリケーション、マイクロサービス、REST APIなどのテンプレートから選択可能
7. 開発者がHKS CLIを用いて、テンプレートを選択するコマンドを実行する、もしくはテンプレートを選択せずに作成する
8. システムがパイプライン設定の詳細プロンプトを表示する
9. 開発者がビルド設定を確認・調整する
   - ビルド戦略（Docker、Buildpack、Kaniko）の選択
   - Dockerfileのパス指定（Dockerビルドの場合）
   - ビルドコンテキストの設定
   - キャッシュ戦略の設定
10. 開発者がデプロイメント設定を確認・調整する
    - デプロイメント戦略（ローリング、ブルーグリーン、カナリー）の選択
    - 環境別設定（開発、ステージング、本番）
    - ヘルスチェックの設定
11. 開発者が環境変数とシークレットを設定する
    - ビルド時環境変数の設定
    - GitHubシークレットとの連携設定
12. 開発者がトリガー設定を確認・調整する
    - プッシュトリガーのブランチパターン（main、develop、feature/*）
    - プルリクエストトリガーの設定
    - スケジュールトリガーの設定（必要に応じて）
13. HKS CLIがここまでのパイプライン設定内容を出力する
14. 開発者は内容に問題が無ければ、HKS CLIでパイプラインを作成するコマンドを実行する
15. システムがパイプライン設定ファイル`.hexabase/pipeline.yml`を生成する
16. 開発者がパイプライン設定ファイルを確認し、リポジトリにコミットする
    - ファイルのパスが異なる場合、開発者は適切な位置(リポジトリルートの`.hexabase`ディレクトリ内）に移動する
17. システムがWebhookをGitHubリポジトリに設定する
18. 開発者がリポジトリにプッシュすると、Webhookによりパイプライン実行が開始される
19. システムがパイプライン実行状況を表示する
20. 開発者がHKS CLIのコマンドでビルドログとデプロイメント状況を確認する

### 4c. 成功シナリオ（基本フロー）:HKS CLIとGitLab使用時

1. 開発者がHKS CLIを使用してGitLab連携コマンドを実行する
   - コマンドオプションで接続先を指定することでSaas版(GitLab.com)とセルフホスト版の切り替えが可能
2. HKS CLIがGitLabへの接続を確立する
3. 開発者がプロジェクトを選択するコマンドを実行する
4. HKS CLIがGitLab統合設定ファイル`.hexabase/gitlab.yml`を生成する
5. システムが利用可能なCI/CDテンプレート一覧を表示する
6. 開発者がテンプレートを選択する
7. 開発者がパイプライン設定ファイル（`.hexabase/pipeline.yml`）を編集する
   - ビルド戦略、デプロイメント戦略、環境変数等を設定
8. 開発者がGitLab CI変数を同期するHKS CLIコマンドを実行する
9. 開発者がGitLab Webhookを自動設定するHKS CLIコマンドを実行する
   - 代案として、ブラウザーを用いてGitLabの設定画面からも設定可能
10. 開発者が設定をリポジトリにコミット・プッシュする
11. システムが初回パイプライン実行を開始する
12. 開発者がHKS CLIのコマンドでビルドログとデプロイメント状況を確認する

## 5. 代替シナリオ（代替フロー）

### 5a. 代替シナリオ（代替フロー）:ブラウザーとGitHubを使用時

#### 5a.1. GitHub認証失敗

- 4a.4a. GitHub認証でエラーが発生する
- 4a.4b. システムがエラーメッセージを表示する
- 4a.4c. 開発者がGitHubの設定でアクセス権限を確認する
- 4a.4d. 開発者が再度認証フローを実行する

#### 5a.2. リポジトリアクセスの権限不足

- 4a.6a. リポジトリが表示されない、または選択できない
- 4a.6b. システムが「アクセス権限が不足しています」というメッセージを表示する
- 4a.6c. 開発者はブラウザーを用いてGitHubにアクセスし、リポジトリへのアクセス権限を確認する
- 4a.6d. 必要に応じて、リポジトリ管理者に権限付与を依頼する

### 5b. 代替シナリオ（代替フロー）:HKS CLIとGitHubを使用時

#### 5b.1. GitHub認証失敗

- 4b.4a. GitHub認証でエラーが発生する
- 4b.4b. システムがエラーメッセージを表示する
- 4b.4c. 開発者がGitHubの設定でアクセス権限を確認する
- 4b.4d. 開発者が再度認証フローを実行する

#### 5b.2. リポジトリアクセスの権限不足

- 4b.6a. リポジトリが表示されない、または選択できない
- 4b.6b. システムが「アクセス権限が不足しています」というメッセージを出力する
- 4b.6c. 開発者はブラウザーを用いてGitHubにアクセスし、リポジトリへのアクセス権限を確認する
- 4b.6d. 必要に応じて、リポジトリ管理者に権限付与を依頼する

### 5c. 代替シナリオ（代替フロー）:HKS CLIとGitLabを使用時

#### 5c.1. GitLab接続失敗

- 4c.2a. GitLabへの接続が確立できない
- 4c.2b. システムが接続エラーを表示する
- 4c.2c. 開発者がネットワーク設定とトークンを確認する
- 4c.2d. 問題解決後、接続コマンドを再実行する

#### 5c.2. PAT（Personal Access Token）権限不足

- 4c.3a. GitLab PATのスコープが不足している
- 4c.3b. システムが「PATの権限不足」エラーを表示する
- 4c.3c. 開発者がGitLabで必要な権限を持ったトークンを再生成する
- 4c.3d. 新しいトークンで接続コマンドを再実行する

#### 5c.3. GitLabプロジェクト選択失敗

- 4c.3a. 対象プロジェクトが表示されない、または選択できない
- 4c.3b. システムが「プロジェクトへのアクセス権限不足」エラーを表示する
- 4c.3c. 開発者がGitLabでプロジェクトのメンバー権限を確認する
- 4c.3d. 権限取得後、プロジェクト選択コマンドを再実行する

#### 5c.4. GitLab統合ファイル生成失敗

- 4c.4a. `.hexabase/gitlab.yml`ファイルの生成に失敗する
- 4c.4b. システムが「GitLab統合ファイル生成失敗」エラーを表示する
- 4c.4c. 開発者が手動でファイルを作成するか、デフォルトテンプレートを使用する
- 4c.4d. ファイル作成後、手順を続行する

#### 5c.5. GitLab CI変数同期失敗

- 4c.8a. GitLab CI変数の同期が失敗する
- 4c.8b. システムが「GitLab CI変数同期失敗」エラーを表示する
- 4c.8c. 開発者が手動でGitLab UIから変数を設定する
- 4c.8d. 変数設定後、パイプライン設定を続行する

#### 5c.6. Webhook設定不可（プライベートネットワーク）

- 4c.9a. プライベートネットワークのGitLabでWebhook設定が失敗する
- 4c.9b. システムが「Hexabase.AIとGitLabが接続できない」エラーを表示する
- 4c.9c. 開発者が以下のいずれかを選択する：
  - GitLab RunnerをHexabase.AI環境のvCluster内にインストール
  - 手動トリガーによるパイプライン実行に切り替え
  - ネットワーク管理者にHexabase.AIとGitLabが接続できるように設定変更を依頼
- 4c.9d. 選択した方法で設定を完了する

### 5d. 共通の代替シナリオ

#### 5d.1. パイプライン設定エラー

- 4a.18a./4b.18a./4c.11a. パイプライン設定ファイルの構文エラー、依存関係のエラー、リソース不足などが発生
- 4a.18b./4b.18b./4c.11b. システムがエラーメッセージを表示する
- 4a.18c./4b.18c./4c.11c. 開発者がエラーメッセージの対処を行う
- 4a.18d./4b.18d./4c.11d. 開発者が修正された設定ファイルをリポジトリにコミット・プッシュする

#### 5d.2. Webhook設定失敗

- 4a.18a./4b.18a./4c.11a. システムが「Webhook設定に失敗しました。リポジトリの設定権限を確認してください」と表示する
- 4a.18b./4b.18b./4c.11b. 開発者がGitHubリポジトリの設定画面から手動でWebhookを設定する

#### 5d.3. ビルド失敗

- 4a.18a./4b.18a./4c.11a. パイプライン実行でビルドエラーが発生する
- 4a.18b./4b.18b./4c.11b. システムが詳細なエラーログを表示する
- 4a.18c./4b.18c./4c.11c. 開発者がビルド設定を修正する
- 4a.18d./4b.18d./4c.11d. 開発者が手動でパイプラインを再実行する

#### 5d.4. CI/CDの利用制限到達

- 4a.18a./4b.18a./4c.11a. リソースクォータまたは利用制限に到達する
- 4a.18b./4b.18b./4c.11b. システムが「リソース制限に到達しました」と詳細情報を表示する
  - CPU/メモリクォータ、namespace制限、同時実行パイプライン数など
- 4a.18c./4b.18c./4c.11c. 開発者が以下のいずれかの対応を行う
  - リソース要求量を削減して再実行する
  - 不要なリソースを削除して空き容量を確保する
  - プランをアップグレードする
- 4a.18d./4b.18d./4c.11d. 制限が解決されるまでユースケースを中断し、解決後に中断したステップから再開する

#### 5d.5. デプロイ失敗

- 4a.19a./4b.19a./4c.12a. システムがデプロイを開始するが、途中で失敗する
- 4a.19b./4b.19b./4c.12b. システムが自動的にロールバック処理を実行し、以前の正常なバージョンに戻す
- 4a.19c./4b.19c./4c.12c. システムが「デプロイに失敗しました」というエラーを表示する
- 4a.19d./4b.19d./4c.12d. 開発者がエラーメッセージを確認し、必要な修正を行う

## 6. 事後条件

- Gitリポジトリ（GitHub/GitLab）とHexabase.AIが連携されている
- CI/CDパイプラインが設定され、`.hexabase/pipeline.yml`がリポジトリに存在する
- リポジトリへのgit pushでパイプラインが自動実行される設定になっている
  - GitHubの場合：Webhookが設定されている
  - GitLabの場合：Webhookまたは代替実行方法が設定されている
- 選択した環境（開発/ステージング/本番）へのデプロイメントが設定されている
  - プランによっては環境が1つで、分離されていないケースあり
- パイプライン実行履歴がシステムで確認可能になっている
- 開発者はビルドログとデプロイメント状況を確認できる

## 7. 補足事項

- パイプライン設定の詳細については[パイプライン設定](../../../cicd/pipeline-configuration.md)を参照
- ビルド戦略の選択については[ビルド戦略](../../../cicd/build-strategies.md)を参照
- GitHub統合の詳細については[GitHub統合](../../../cicd/github-integration.md)を参照
- GitLab統合の詳細については[GitLab統合](../../../cicd/gitlab-integration.md)を参照
- デプロイメント自動化については[デプロイメント自動化](../../../cicd/deployment-automation.md)を参照

## 8. 仕様未定／要検討

- TODO: CI/CDの実行先は？
  - Hexabase.AI がホスティングしたCI/CDの場合プランによる制限があるのか？
- TODO: Hexabase.AIはブラウザーからGitLabのCI/CDは連携設定が可能か？
  - GitLabにはセルフホスト版が存在し、ホスティング先のネットワーク環境によってはシステムからアクセスできるとは限らない
  - この問題はブラウザーUIにGitLabのURLを入力する方法でも解決できない
  - アクセス可能な開発者のネットワーク環境を用いるために、意図的にCLI限定にしている？
  - アクセスできない場合の代替手段、GitLab RunnerをHexabase.AI環境のvCluster内は使用を認めるか？
- 4a.16./4b.16/4c.10. TODO: パイプライン設定ファイルのコミット方法
  - 利便性のために、PRの自動作成などを行うか？
