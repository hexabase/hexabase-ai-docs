# IdPでHexabase.AIに初回ログインする

## 1. ユースケース名

IdPを用いてHexabase.AIに初回ログインする

## 2. アクター（実行者）

- **主アクター：** 新規ユーザー、開発者(以下、ユーザー)
- **副アクター：** Hexabase.AIシステム(以下、システム)
- **副アクター：** システムがサポートするIdP（GitHub、Google等）

## 3. 事前条件

- ユーザーがIdPのアカウントを持っている
- インターネット接続が利用可能である
- ユーザーはブラウザーまたはHKS CLIが利用可能である
- ユーザーがHexabase.AIのアカウントを持っていない

## 4a. 成功シナリオ（基本フロー）:ブラウザー使用時

1. ユーザーがブラウザー上でHexabase.AIの公式サイトにアクセスする
2. ユーザーが任意のIdPを用いた"ログイン"ボタンをクリックする
   - "Googleでログイン"、"GitHubでログイン"のようなボタンの中から、任意のIdPを選択する
3. システムがユーザーをIdPの認証画面にリダイレクトする
4. ユーザーがIdPで認証を行う
5. ユーザーがHexabase.AIへのアクセス許可を承認する(IdPによっては省略のケースあり)
6. システムがブラウザーをHexabase.AIサイトに戻す
7. システムがブラウザー上に利用規約とプライバシーポリシーを表示する
8. ユーザーが利用規約とプライバシーポリシーに同意する
9. システムがアカウント、個人用の組織を作成する
10. システムによってブラウザーにダッシュボードが表示される

## 4b. 成功シナリオ（基本フロー）:HKS CLI使用時

1. ユーザーはHKS CLIを用いてログインする
2. HKS CLIはブラウザーを開き、IdPの認証画面を開く
3. ユーザーがIdPで認証を行う
4. ユーザーがHexabase.AIへのアクセス許可を承認する(IdPによっては省略のケースあり)
5. システムがブラウザーをHexabase.AIサイトにリダイレクトする
6. システムがユーザーにHKS CLIの画面に戻るように促す表示をする、この画面はユーザーによって閉じられる、または時間経過で自動に閉じる
7. ユーザーはHKS CLIに戻る
8. システムはHKS CLI上に利用規約とプライバシーポリシーを出力する
9. ユーザーが利用規約とプライバシーポリシーに同意する
10. システムがアカウント、個人用の組織を作成する
11. システムによって初回ログイン処理が正常に終了したことを出力する

## 5a. 代替シナリオ（代替フロー）

### 5a. 代替シナリオ（代替フロー）:ブラウザー使用時

#### 5a.1. IdPサービス障害

- 4a.4a. IdPのサービスが利用できない状態にある
- 4a.4b. システムが「認証サービスが一時的に利用できません」と表示し、時間をおいてリトライを促す
- 4a.4c. ユーザーが時間をおいて再試行する

#### 5a.2. Hexabase.AIのアクセスを拒否またはキャンセル

- 4a.5a. ユーザーがIdPでのHexabase.AIのアクセスを拒否する
- 4a.5b. システムが"アクセスが許可されませんでした"と表示する
- 4a.5c. 再度認証を行う場合、ユーザーはログインをやり直す

#### 5a.3. ユーザーが規約に同意しない

- 4a.7a. ユーザーが利用規約とプライバシーポリシーに同意しない
- 4a.7b. システムはユーザーアカウントを作成しない(システム上に何もデータが作成されていない)
- 4a.7c. システムは"同意しないためシステムを利用できない"と表示する

#### 5a.4. ユーザーアカウントと組織の作成失敗

- 4a.10a. システムの障害によりユーザーアカウントもしくは組織の作成に失敗する
- 4a.10b. システムはユーザーと組織の両方を作成前の状態に戻す
  - DBにユーザーと組織が登録されていない状態
- 4a.10c. システムは"アカウント作成に失敗した旨をユーザーに通知する"と表示する
- 4a.10d. ユーザーは再度ログインを行う

### 5b. 代替シナリオ（代替フロー）:HKS CLI使用時

#### 5b.1. IdPサービス障害

- 4b.4a. IdPのサービスが利用できない状態にある
- 4b.4b. システムが「認証サービスが一時的に利用できません」と出力し、時間をおいてリトライを促す
- 4b.4d. ユーザーが時間をおいて再試行する

#### 5b.2. Hexabase.AIのアクセスを拒否またはキャンセル

- 4b.5a. ユーザーがIdPでのHexabase.AIのアクセスを拒否する
- 4b.5b. システムが"アクセスが許可されませんでした"と出力する
- 4b.5c. 再度認証を行う場合、ユーザーはログインをやり直す

#### 5b.3. ユーザーが利用規約とプライバシーポリシーに同意しない

- 4b.7a. ユーザーが利用規約とプライバシーポリシーに同意しない
- 4b.7b. システムはユーザーアカウントを作成しない(システム上に何もデータが作成されていない)
- 4b.7c. システムは"同意しないためシステムを利用できない"と出力する

#### 5b.4. ユーザーアカウントと組織の作成失敗

- 4b.10a. システムの障害によりユーザーアカウントもしくは組織の作成に失敗する
- 4b.10b. システムはユーザーと組織の両方を作成前の状態に戻す
  - DBにユーザーと組織が登録されていない状態
- 4b.10c. システムは"ユーザー作成に失敗しました"と出力する
- 4b.10d. ユーザーは再度ログインを行う

## 6. 事後条件

- 新規ユーザーアカウントと組織がHexabase.AIに作成されている
- ユーザーがログイン状態になっている
- IdPの連携が有効になっている
- ユーザーがダッシュボードにアクセスできる
  - ブラウザー：ダッシュボードのページで確認する
  - HKS CLI: 確認するためのコマンドを実行する

## 7. 補足事項

- GitHubの場合：2段階認証やメール非公開設定により追加ステップが発生する可能性がある
- Googleの場合：複数アカウント選択や企業制限により追加確認が必要な場合がある
- HKS CLIによる状態確認など、具体的な操作方法については[CLI Tool](../../../sdk/cli.md)を参照

## 8. 仕様未定／要検討

- 全体 TODO: 組織へ招待での登録の場合、このシナリオを反映させるか？
  - ユーザーの作成は必要だが、個人用組織の作成は不要か？
- 全体 TODO: 各代替シナリオのエラー画面は専用のエラー画面にするか、ログイン画面に表示するか？
  - 5a1 IdPサービス障害
  - 5a.2 認証の拒否
  - 5a.7 ユーザーが規約に同意しない
  - 5a.10 ユーザーアカウントと組織の作成失敗
- 4a.7/4b.10 TODO: 利用規約等の同意はこのタイミングか？もっと早い段階で行うか？
- 4b.7 TODO: HKS CLI 使用時のブラウザーに表示後、自動的にブラウザーを閉じるか？
- 4a.9/4b.10: TODO: 初期組織の設定値、名前の決定方法
