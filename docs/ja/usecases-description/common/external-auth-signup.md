# IdPでHexabase.AIに初回ログインする

## 1. ユースケース名

IdPを用いてHexabase.AIに初回ログインする

## 2. アクター（実行者）

- **主アクター：** 新規ユーザー、開発者(以下、ユーザー)
- **副アクター：** Hexabase.AIシステム(以下、システム)
- **副アクター：** HKS CLI(CLIからHexabase.AIシステムを利用するためのツール)
- **副アクター：** システムがサポートするIdP（GitHub、Google等）

## 3. 事前条件

- ユーザーがIdPのアカウントを持っている
- インターネット接続が利用可能である
- ユーザーはブラウザーまたはHKS CLIが利用可能である
- ユーザーがHexabase.AIのアカウントを持っていない

## 4. 成功シナリオ（基本フロー）

### 4a. 成功シナリオ（基本フロー）:ブラウザー使用時

1. ユーザーがブラウザー上でHexabase.AIのサイトにアクセスする
2. システムがログインページに利用規約とプライバシーポリシーを表示する
   - "ログインした場合、この規約とポリシーに同意したとみなす"という表記も行う
3. ユーザーが利用規約とプライバシーポリシーを確認する
4. ユーザーが任意のIdPを用いた"ログイン"ボタンをクリックする
   - "Googleでログイン"、"GitHubでログイン"のようなボタンの中から、任意のIdPを選択する
5. システムがユーザーをIdPの認証画面にリダイレクトする
6. ユーザーがIdPで認証を行う
7. ユーザーがHexabase.AIへのアクセス許可を承認する(IdPによっては省略のケースあり)
8. システムがブラウザーをHexabase.AIサイトに戻す
9. システムがユーザーアカウントを作成する
10. システムが個人用の組織を作成する
    - 組織は初期値で作成する
    - ユーザーはこの組織の"管理者"となる
11. システムによってブラウザーにダッシュボードが表示される
12. ユーザーは必要ならば組織の情報を変更する

### 4b. 成功シナリオ（基本フロー）:HKS CLI使用時

1. ユーザーはHKS CLIを用いてログインする
2. HKS CLIは初回起動時、利用規約とプライバシーポリシーを表示する
   - もしくは、ブラウザーを開き利用規約とプライバシーポリシーを表示する
3. HKS CLIはブラウザーを開き、IdPの認証画面を開く
4. ユーザーがIdPで認証を行う
5. ユーザーがHexabase.AIへのアクセス許可を承認する(IdPによっては省略のケースあり)
6. システムがブラウザーをHexabase.AIサイトにリダイレクトする
7. システムがユーザーにHKS CLIの画面に戻るように促す表示をする、この画面はユーザーによって閉じられる、または時間経過で自動に閉じる
8. ユーザーはHKS CLIに戻る
9. システムがユーザーアカウントを作成する
10. システムが個人用の組織を作成する
    - 組織は初期値で作成する
    - ユーザーはこの組織の"管理者"となる
11. システムによって初回ログイン処理が正常に終了したことを出力する
12. ユーザーは作成されたアカウントと組織の情報を確認し、必要ならば組織の情報を変更する

## 5a. 代替シナリオ（代替フロー）

### 5a. 代替シナリオ（代替フロー）:ブラウザー使用時

#### 5a.1. ユーザーが規約に同意しない

- 4a.3a. ユーザーが利用規約とプライバシーポリシーに同意しない
- 4a.3b. ユーザーはブラウザーを閉じるなどして、Hexabase.AIから離れる

#### 5a.2. IdPサービス障害

- 4a.6a. IdPのサービスが利用できない状態にある
- 4a.6b. システムが「認証サービスが一時的に利用できません」と表示し、時間をおいてリトライを促す
- 4a.6c. ユーザーが時間をおいて再試行する

#### 5a.3. Hexabase.AIのアクセスを拒否またはキャンセル

- 4a.7a. ユーザーがIdPでのHexabase.AIのアクセスを拒否する
- 4a.7b. システムが"アクセスが許可されませんでした"と表示する
- 4a.7c. 再度認証を行う場合、ユーザーはログインをやり直す

#### 5a.4. ユーザーアカウントの作成失敗

- 4a.9a. システムの障害によりユーザーアカウントの作成に失敗する
  - アクセス集中、DBとの接続エラー等
- 4a.9b. システムはユーザーを作成前の状態に戻す
  - DBにユーザーが登録されていない状態
- 4a.9c. システムは"ユーザーアカウント作成に失敗した"と表示する
- 4a.9d. ユーザーは再度ログインを行う、解決しない場合はシステムサポートに連絡する

#### 5a.5. 組織の作成失敗

- 4a.10a. システムの障害により組織の作成に失敗する
  - アクセス集中、DBとの接続エラー等
- 4a.10b. システムはユーザーアカウントと組織を作成前の状態に戻す
  - DBにユーザーと組織が登録されていない状態
- 4a.10c. システムは"ユーザーアカウント作成に失敗した"と表示する
- 4a.10d. ユーザーは組織を作成する、解決しない場合はシステムサポートに連絡する

### 5b. 代替シナリオ（代替フロー）:HKS CLI使用時

#### 5b.1. ユーザーが利用規約とプライバシーポリシーに同意しない

- 4b.2a. ユーザーが利用規約とプライバシーポリシーに同意しない
- 4b.2b. ユーザーは以降の作業を行わない

#### 5b.2. CLIからブラウザーを開けない場合

- 4b.3a. HKS CLIはURLを出力する
- 4b.3b. ユーザーはURLをブラウザーのアドレスバーにコピーし作業を続行する

#### 5b.3. IdPサービス障害

- 4b.4a. IdPのサービスが利用できない状態にある
- 4b.4b. システムが「認証サービスが一時的に利用できません」と出力し、時間をおいてリトライを促す
- 4b.4c. ユーザーが時間をおいて再試行する

#### 5b.4. Hexabase.AIのアクセスを拒否またはキャンセル

- 4b.5a. ユーザーがIdPでのHexabase.AIのアクセスを拒否する
- 4b.5b. システムが"アクセスが許可されませんでした"と出力する
- 4b.5c. 再度認証を行う場合、ユーザーはログインをやり直す

#### 5b.5. ユーザーアカウントの作成失敗

- 4b.9a. システムの障害によりユーザーアカウントの作成に失敗する
  - アクセス集中、DBとの接続エラー等
- 4b.9b. システムはユーザーを作成前の状態に戻す
  - DBにユーザーが登録されていない状態
- 4b.9c. システムは"ユーザーアカウントの作成に失敗した"と出力する
- 4b.9d. ユーザーは再度ログインを行う、解決しない場合はシステムサポートに連絡する

#### 5b.6. 組織の作成失敗

- 4b.10a. システムの障害により組織の作成に失敗する
  - アクセス集中、DBとの接続エラー等
- 4b.10b. システムはユーザーアカウントと組織を作成前の状態に戻す
  - DBにユーザーと組織が登録されていない状態
- 4b.10c. システムは"ユーザーアカウントの作成に失敗した"と出力する
- 4b.10d. ユーザーは再度ログインを行う、解決しない場合はシステムサポートに連絡する

## 6. 事後条件

- 新規ユーザーのアカウントと組織がHexabase.AIに作成されている
- ユーザーがログイン状態になっている
- IdPの連携が有効になっている
- ユーザーがダッシュボードにアクセスできる
  - ブラウザー：ダッシュボードのページで確認する
  - HKS CLI: 確認するためのコマンドを実行する

## 7. 補足事項

- GitHubの場合：2段階認証やメール非公開設定により追加ステップが発生する可能性がある
- Googleの場合：複数アカウント選択や企業制限により追加確認が必要になる可能性がある
- その他IdPについて：それぞれ必要な作業が発生する可能性がある
- HKS CLIの詳細な使用方法については、各機能のドキュメントを参照

## 8. 仕様未定／要検討

- 全体 TODO: 組織へ招待での登録の場合、このシナリオを反映させるか？
  - ユーザーの作成は必要だが、個人用組織の作成は不要か？
- 全体 TODO: 各代替シナリオのエラー画面は専用のエラー画面にするか、ログイン画面に表示するか？
  - 5a.1. IdPサービス障害
  - 5a.2. 認証の拒否
  - 5a.7. ユーザーが規約に同意しない
  - 5a.10 ユーザーアカウントと組織の作成失敗
- 5a.2./5b.3. TODO: IdPが障害で使用できないときのログイン方法
  - 代替ログイン方法を準備するのか？
  - 一つのアカウントに複数のIdPを紐付け可能にするのか？
- 4b.7. TODO: HKS CLI 使用時のブラウザーに表示後、自動的にブラウザーを閉じるか？
- 4a.9./4b.9.: TODO: 初期組織の設定値、名前の決定方法
